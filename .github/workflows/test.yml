name: Test
on:
  # Run CI on all pushes to the master and release/** branches, and on all new
  # pull requests, and on all pushes to pull requests (even if a pull request
  # is not against master).
  push:
    branches:
      - "master"
      - "release/**"
  pull_request:
  schedule:
    - cron: "0 0,12 * * *"

concurrency:
  group: ${{ github.ref_name || github.sha }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash
jobs:
  test:
#    if: github.repository_owner == 'getsentry'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        container_engine: ['docker', 'podman']
    name: tests
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Compose
        if: matrix.container_engine == 'docker'
        uses: ./get-compose-action

      - name: Install Podman
        if: matrix.container_engine == 'podman'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends podman podman-docker

          # temporary increate nofile limit
          echo "$USER hard nofile 1500000" | sudo tee /etc/security/limits.d/50-podman-ulimits.conf

          # TODO: Replace below with podman-compose
          #       We need this commit to be able to work: https://github.com/containers/podman-compose/commit/8206cc3ea277eee6c2e87d4cd66eba8eae3d44eb
          pip3 install --user https://github.com/containers/podman-compose/archive/main.tar.gz
          echo "PODMAN_COMPOSE_PROVIDER=podman-compose" >> $GITHUB_ENV
          echo "PODMAN_COMPOSE_WARNING_LOGS=false" >> $GITHUB_ENV

      - name: Unit Tests (${{ matrix.container_engine }})
        env:
          CONTAINER_ENGINE_PODMAN: ${{ matrix.container_engine == 'podman' && '1' || '0' }}
          DEBUG: '1'
        run: ./unit-test.sh

      - name: Integration test (${{ matrix.container_engine }})
        uses: './'
        env:
          REPORT_SELF_HOSTED_ISSUES: 0
          SELF_HOSTED_TESTING_DSN: ${{ vars.SELF_HOSTED_TESTING_DSN }}
          CONTAINER_ENGINE_PODMAN: ${{ matrix.container_engine == 'podman' && '1' || '0' }}
        with:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
          container_engine: ${{ matrix.container_engine }}

      - name: Inspect failure
        if: failure()
        run: |
          docker compose ps
          docker compose logs
